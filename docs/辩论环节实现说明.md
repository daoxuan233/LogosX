# 辩论环节实现说明（四阶段赛制）

本文档说明本项目“辩论环节（stage）”的编排规则：如何把总轮数按四个环节的比重分配，并保证输出文档中的环节名称与赛制一致。

## 1. 赛制环节（严格名称）

| 环节名称 | 发言人 | 轮数体现比重 | 核心任务 |
| :-- | :-- | :--: | :-- |
| 开篇立论 | 正 / 反 | 21% | 逻辑框架建立、逻辑铺垫 |
| 攻辩/质询 | 正 / 反 | 16% | 质疑对方论据真实性 |
| 自由辩论 | 一方结束另一方立刻发言 | 36% | 捕捉逻辑漏洞、多点交锋 |
| 总结陈词 | 反 / 正 | 27% | 梳理战场、定调价值 |

说明：

- 本项目的“轮”是一个完整回合：主席提醒 → 正反各发言一次 → 主席评估。
- “总结陈词”的发言顺序固定为反方先、正方最后，以满足“反 / 正”的赛制要求。

## 2. 轮次分配（从百分比到整数轮）

现实执行中，总轮数必须是整数，因此需要把百分比换算为整数轮次，同时满足：

1. 四个环节的轮次数之和必须等于总轮数；
2. 分配结果应尽量贴近原始比重；
3. 结果需要确定（同样的总轮数给出同样的分配）。

本项目采用“最大余数法（Hamilton method）”进行整数化：

1. 对每个环节计算 `raw = weight * total_rounds`；
2. 取 `floor(raw)` 作为基础轮次；
3. 剩余的轮次按 `raw - floor(raw)` 的小数余数从大到小依次补齐；
4. 当 `total_rounds >= 4` 时，额外保证每个环节至少 1 轮（若出现 0 轮，会从轮次最多的环节挪 1 轮补齐）。

### 示例：20 轮

- 开篇立论：0.21 * 20 = 4.2 → 4
- 攻辩/质询：0.16 * 20 = 3.2 → 3
- 自由辩论：0.36 * 20 = 7.2 → 7
- 总结陈词：0.27 * 20 = 5.4 → 5

基础轮次之和为 19，剩余 1 轮补给余数最大的“总结陈词”（0.4），最终得到：

- 4 / 3 / 7 / 6

## 3. 环节判定（轮次区间）

在得到每个环节的轮次数后，会计算累计边界：

- 第 1 ~ 开篇立论轮数：开篇立论
- 其后连续 攻辩/质询轮数：攻辩/质询
- 其后连续 自由辩论轮数：自由辩论
- 剩余轮次：总结陈词

你会在输出的 Markdown 里看到形如：

- `**📌 环节**：开篇立论`
- `**📌 环节**：攻辩/质询`
- `**📌 环节**：自由辩论`
- `**📌 环节**：总结陈词`

## 4. 任务注入（每轮“该做什么”）

每个环节都会向辩手提示词注入“本轮核心任务”，以保证生成内容与赛制一致：

- 开篇立论：强调定义、衡量标准、2-3条核心论点与推理链
- 攻辩/质询：强调短问短答、证据真实性、因果链条与可检验性
- 自由辩论：强调多点交锋、捕捉漏洞、快速推进争点
- 总结陈词：强调梳理战场与价值定调（反方先、正方最后）

## 5. 代码位置

- 环节轮次分配：`debate_arena/orchestration/graph.py` 中的 `allocate_stage_counts`
- 轮次 → 环节判定：`debate_arena/orchestration/graph.py` 中的 `determine_stage`
- 环节任务注入：`debate_arena/orchestration/graph.py` 中的 `task_instruction_for`

